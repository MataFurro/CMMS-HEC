<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger HEC | Reporte Clínico</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="messenger-container">
        <div class="report-card">
            <div class="header">
                <h1>Messenger HEC</h1>
                <p>Envíe su reporte de equipo a Mantenimiento en segundos.</p>
            </div>

            <form id="reportForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Su Correo</label>
                    <div class="input-wrapper">
                        <input type="email" name="email" placeholder="ejemplo@hec.cl" required>
                        <span class="material-icons-round icon">alternate_email</span>
                    </div>
                </div>

                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>S/N (Serie) *</label>
                        <div class="input-wrapper">
                            <input type="text" name="serie" placeholder="N° de Serie" required>
                            <span class="material-icons-round icon">fingerprint</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Servicio</label>
                        <div class="input-wrapper">
                            <select name="servicio" required style="padding-left: 3rem;">
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Urgencias">Urgencias</option>
                                <option value="UCI">UCI</option>
                                <option value="Pabellón">Pabellón</option>
                                <option value="Laboratorio">Laboratorio</option>
                                <option value="Radiología">Radiología</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <span class="material-icons-round icon">apartment</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Equipo</label>
                    <div class="input-wrapper">
                        <input type="text" name="equipo" placeholder="Nombre de equipo" required>
                        <span class="material-icons-round icon">medical_services</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripción de la Falla</label>
                    <div class="input-wrapper">
                        <textarea name="texto" placeholder="¿Qué está pasando con el equipo?" required></textarea>
                        <span class="material-icons-round icon">description</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Evidencia Visual (Opcional)</label>
                    <div class="file-upload" id="dropzone">
                        <input type="file" name="imagen" id="imageInput" accept="image/*">
                        <span class="material-icons-round upload-icon">add_a_photo</span>
                        <p style="font-size: 0.75rem; color: var(--text-secondary);">Subir o arrastrar imagen</p>
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <img id="imagePreview" src="" alt="Vista previa">
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span>Enviar Reporte</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const reportForm = document.getElementById('reportForm');
        const submitBtn = document.getElementById('submitBtn');

        // Image Preview Logic
        imageInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // Form Submission Logic
        reportForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-icons-round rotate">sync</span> PROCESANDO...';
            submitBtn.style.opacity = '0.7';

            const formData = new FormData(this);

            try {
                const response = await fetch('messenger.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('✅ ¡Reporte enviado! ID de rastreo: ' + result.tracking_id);
                    reportForm.reset();
                    previewContainer.style.display = 'none';
                } else {
                    alert('❌ Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error de conexión con el Mensajero.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                submitBtn.style.opacity = '1';
            }
        });
    </script>

    <style>
        .rotate {
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>